#!/bin/bash

##############################################################################
# resymlink - Rename source directory and update symlinks
#
# Usage: resymlink <old-directory-path> <new-directory-path>
#
# Renames a source directory and updates all symlinks in the shoebox archive
# that point to files in that directory.
#
# Example:
#   resymlink /home/mbudd/Documents/GOIndia/2017-KumarKollegalStore \
#             /home/mbudd/Documents/GOIndia/2017-SatyavadiKollegalStore
##############################################################################

# Hard-coded path to the resource directory containing photo/, video/, audio/
RESOURCE_DIR="/home/mbudd/Documents/GOIndia/shoebox"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

##############################################################################
# Functions
##############################################################################

print_usage() {
    echo "Usage: resymlink <old-directory-path> <new-directory-path>"
    echo ""
    echo "Renames a directory and updates symlinks in shoebox archive."
    echo ""
    echo "Example:"
    echo "  resymlink /home/mbudd/Documents/GOIndia/2017-KumarKollegalStore \\"
    echo "            /home/mbudd/Documents/GOIndia/2017-SatyavadiKollegalStore"
    exit 1
}

# Validate arguments
validate_args() {
    if [[ $# -ne 2 ]]; then
        echo -e "${RED}Error: Expected 2 arguments${NC}"
        print_usage
    fi
    
    OLD_DIR="$1"
    NEW_DIR="$2"
    
    # Remove trailing slashes for consistency
    OLD_DIR="${OLD_DIR%/}"
    NEW_DIR="${NEW_DIR%/}"
    
    # Convert to absolute paths if relative
    if [[ ! "$OLD_DIR" = /* ]]; then
        OLD_DIR="$(cd "$OLD_DIR" && pwd)"
        if [[ $? -ne 0 ]]; then
            echo -e "${RED}Error: Could not resolve old directory path${NC}"
            exit 1
        fi
    fi
    
    if [[ ! "$NEW_DIR" = /* ]]; then
        # For new dir, we need to check if parent exists first
        NEW_DIR_PARENT=$(dirname "$NEW_DIR")
        NEW_DIR_NAME=$(basename "$NEW_DIR")
        if [[ -d "$NEW_DIR_PARENT" ]]; then
            NEW_DIR="$(cd "$NEW_DIR_PARENT" && pwd)/$NEW_DIR_NAME"
        else
            # Use current directory as base
            NEW_DIR="$(pwd)/$NEW_DIR"
        fi
    fi
    
    # Check if old directory exists
    if [[ ! -d "$OLD_DIR" ]]; then
        echo -e "${RED}Error: Old directory does not exist: $OLD_DIR${NC}"
        exit 1
    fi
    
    # Check if new directory already exists
    if [[ -d "$NEW_DIR" ]]; then
        echo -e "${RED}Error: New directory already exists: $NEW_DIR${NC}"
        echo -e "${YELLOW}Choose a different name or remove the existing directory${NC}"
        exit 1
    fi
    
    # Check if parent of new directory exists
    NEW_PARENT=$(dirname "$NEW_DIR")
    if [[ ! -d "$NEW_PARENT" ]]; then
        echo -e "${RED}Error: Parent directory does not exist: $NEW_PARENT${NC}"
        exit 1
    fi
    
    # Validate resource directory exists
    if [[ ! -d "$RESOURCE_DIR" ]]; then
        echo -e "${RED}Error: Resource directory not found: $RESOURCE_DIR${NC}"
        exit 1
    fi
}

# Process symlinks in a given directory
process_directory() {
    local dir_name="$1"
    local dir_path="$RESOURCE_DIR/$dir_name"
    local count=0
    
    if [[ ! -d "$dir_path" ]]; then
        echo -e "${YELLOW}  Directory not found: $dir_path (skipping)${NC}"
        return 0
    fi
    
    echo -e "${BLUE}Scanning $dir_name/ directory...${NC}"
    
    # Find all symlinks in the directory
    while IFS= read -r -d '' symlink; do
        # Get the target of the symlink
        target=$(readlink "$symlink")
        
        # Check if this is an absolute path symlink pointing to old directory
        if [[ "$target" == "$OLD_DIR"/* ]]; then
            # Extract the relative part after the old directory
            relative_path="${target#$OLD_DIR/}"
            
            # Construct new target path
            new_target="$NEW_DIR/$relative_path"
            
            # Check if the new target exists
            if [[ ! -e "$new_target" ]]; then
                echo -e "${RED}  ✗ Warning: New target doesn't exist: $new_target${NC}"
                echo -e "    Symlink: $(basename "$symlink")"
                echo -e "    Skipping..."
                continue
            fi
            
            # Update the symlink
            ln -sf "$new_target" "$symlink"
            
            if [[ $? -eq 0 ]]; then
                echo -e "${GREEN}  ✓ Updated: $(basename "$symlink")${NC}"
                echo -e "    Old: $target"
                echo -e "    New: $new_target"
                ((count++))
            else
                echo -e "${RED}  ✗ Failed to update: $(basename "$symlink")${NC}"
            fi
        fi
    done < <(find "$dir_path" -type l -print0)
    
    if [[ $count -eq 0 ]]; then
        echo -e "  No symlinks found pointing to old directory"
    fi
    
    echo ""
    return $count
}

##############################################################################
# Main
##############################################################################

echo -e "${BLUE}==================================================================${NC}"
echo -e "${BLUE}Resymlink - Rename directory and update symlinks${NC}"
echo -e "${BLUE}==================================================================${NC}"
echo ""

# Validate arguments
validate_args "$@"

echo "Old directory: $OLD_DIR"
echo "New directory: $NEW_DIR"
echo "Resource dir:  $RESOURCE_DIR"
echo ""

# Confirm with user
read -p "Proceed with renaming directory and updating symlinks? (y/N) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi
echo ""

# Rename the directory
echo -e "${BLUE}Renaming directory...${NC}"
mv "$OLD_DIR" "$NEW_DIR"

if [[ $? -ne 0 ]]; then
    echo -e "${RED}✗ Failed to rename directory${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Directory renamed successfully${NC}"
echo ""

# Process each media type directory
total_updated=0

process_directory "photo"
photo_count=$?
total_updated=$((total_updated + photo_count))

process_directory "video"
video_count=$?
total_updated=$((total_updated + video_count))

process_directory "audio"
audio_count=$?
total_updated=$((total_updated + audio_count))

# Summary
echo -e "${BLUE}==================================================================${NC}"
echo -e "${GREEN}Summary:${NC}"
echo "  Photo symlinks updated: $photo_count"
echo "  Video symlinks updated: $video_count"
echo "  Audio symlinks updated: $audio_count"
echo -e "${GREEN}  Total symlinks updated: $total_updated${NC}"
echo -e "${BLUE}==================================================================${NC}"

if [[ $total_updated -gt 0 ]]; then
    echo ""
    echo -e "${GREEN}✓ Directory renamed and symlinks updated successfully!${NC}"
else
    echo ""
    echo -e "${YELLOW}Directory renamed, but no symlinks were updated.${NC}"
    echo -e "${YELLOW}Possible reasons:${NC}"
    echo -e "${YELLOW}  - No symlinks point to files in this directory${NC}"
    echo -e "${YELLOW}  - The symlinks use relative paths instead of absolute paths${NC}"
fi

exit 0
